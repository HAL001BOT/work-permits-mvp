<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Permits - Work Permits</title>
  <link rel="stylesheet" href="/css/style.css" />
</head>
<body>
  <main class="container">
    <header class="page-header row space-between wrap gap-md">
      <div class="header-brand row gap-md">
        <img src="/img/sachem.gif" alt="Sachem" class="header-logo" />
        <div>
          <h1>Work Permits Dashboard</h1>
          <p class="muted">Track permit status, approvals, and revisions in one place.</p>
        </div>
      </div>
      <div class="row gap wrap">
        <span class="badge">Signed in as <strong><%= user.username %></strong> (<%= user.role %>)</span>
        <% if (user.role === 'admin') { %><a class="button" href="/admin/users">Manage Users</a><% } %>
        <form method="post" action="/logout"><button type="submit" class="button ghost">Logout</button></form>
      </div>
    </header>

    <section class="stats-grid">
      <article class="stat-card"><h3>Total permits</h3><p class="stat-value"><%= stats.total %></p></article>
      <% Object.entries(stats.statusCounts).forEach(([status, count]) => { %>
        <article class="stat-card"><h3><%= status.charAt(0).toUpperCase() + status.slice(1) %></h3><p class="stat-value"><%= count %></p></article>
      <% }) %>
    </section>

    <section class="card">
      <h2 class="section-title">Filters</h2>
      <form method="get" action="/permits" class="grid-form">
        <label>Status
          <select name="status">
            <option value="">All</option>
            <% statusOptions.forEach(s => { %>
              <option value="<%= s %>" <%= filters.status === s ? 'selected' : '' %>><%= s %></option>
            <% }) %>
          </select>
        </label>
        <label>Submitted By
          <select name="submittedBy">
            <option value="">All</option>
            <% submitters.forEach(u => { %>
              <option value="<%= u.id %>" <%= String(filters.submittedBy || '') === String(u.id) ? 'selected' : '' %>><%= u.username %></option>
            <% }) %>
          </select>
        </label>
        <label>From<input type="date" name="startDate" value="<%= filters.startDate %>" /></label>
        <label>To<input type="date" name="endDate" value="<%= filters.endDate %>" /></label>
        <div class="row gap wrap"><button type="submit" class="button primary">Apply</button><a class="button ghost" href="/permits">Clear</a></div>
      </form>
    </section>

    <section class="card">
      <div class="row gap wrap">
        <% if (permissions.canCreate) { %><a class="button primary" href="/permits/new">New Permit</a><% } %>
        <a class="button" href="/permits/export.csv?status=<%= encodeURIComponent(filters.status) %>&submittedBy=<%= encodeURIComponent(filters.submittedBy) %>&startDate=<%= encodeURIComponent(filters.startDate) %>&endDate=<%= encodeURIComponent(filters.endDate) %>">Export CSV</a>
      </div>
    </section>

    <section class="table-card card">
      <div class="table-wrap">
        <table>
          <thead><tr><th class="id-col">ID</th><th>Permit Number</th><th>Permit Date</th><th>By</th><th>Status</th></tr></thead>
          <tbody>
            <%
              const childMap = {};
              permits.filter(p => p.parent_permit_id).forEach(c => {
                if (!childMap[c.parent_permit_id]) childMap[c.parent_permit_id] = [];
                childMap[c.parent_permit_id].push(c);
              });
              const parents = permits.filter(p => !p.parent_permit_id);
            %>

            <% parents.forEach(p => {
                 const children = childMap[p.id] || [];
                 const hasChildren = children.length > 0;
            %>
              <tr class="click-row" data-href="/permits/<%= p.id %>">
                <td class="id-col">
                  <% if (hasChildren) { %>
                    <button type="button" class="button ghost id-toggle" data-toggle="children-<%= p.id %>" aria-expanded="false">+</button>
                  <% } else { %>
                    <span class="id-toggle-spacer"></span>
                  <% } %>
                  <span><%= p.id %></span>
                </td>
                <td><strong><%= p.permit_number || p.title %></strong></td>
                <td><%= p.permit_date %></td>
                <td><%= p.updated_by_name %></td>
                <td><span class="status-pill status-<%= p.status %>"><%= p.status %></span></td>
              </tr>

              <% children.forEach(c => { %>
                <tr class="child-row child-of-<%= p.id %> click-row" data-href="/permits/<%= c.id %>" style="display:none; background:#f8fafc;">
                  <td class="id-col child-id-col">↳ <%= c.id %></td>
                  <td><strong><%= c.permit_number || c.title %></strong></td>
                  <td><%= c.permit_date %></td>
                  <td><%= c.updated_by_name %></td>
                  <td><span class="status-pill status-<%= c.status %>"><%= c.status %></span></td>
                </tr>
              <% }) %>
            <% }) %>

            <% if (!parents.length) { %><tr><td colspan="5" class="muted">No permits found.</td></tr><% } %>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    document.querySelectorAll('[data-toggle]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const key = btn.getAttribute('data-toggle').replace('children-', '');
        const rows = document.querySelectorAll('.child-of-' + key);
        const expanded = btn.getAttribute('aria-expanded') === 'true';
        rows.forEach(r => r.style.display = expanded ? 'none' : 'table-row');
        btn.setAttribute('aria-expanded', expanded ? 'false' : 'true');
        btn.textContent = expanded ? '+' : '−';
      });
    });

    document.querySelectorAll('tr.click-row').forEach((row) => {
      row.style.cursor = 'pointer';
      row.addEventListener('click', () => {
        const href = row.getAttribute('data-href');
        if (href) window.location.href = href;
      });
    });
  </script>
</body>
</html>
