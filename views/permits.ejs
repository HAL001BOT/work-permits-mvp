<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Permits - Work Permits</title>
  <link rel="stylesheet" href="/css/style.css" />
</head>
<body>
  <main class="container">
    <header class="page-header row space-between wrap gap-md">
      <div class="header-brand row gap-md">
        <img src="/img/sachem.gif" alt="Sachem" class="header-logo" />
        <div>
          <h1>Work Permits Dashboard</h1>
          <p class="muted">Track permit status, approvals, and revisions in one place.</p>
        </div>
      </div>
      <div class="row gap wrap">
        <span class="badge">Signed in as <strong><%= user.username %></strong> (<%= user.role %>)</span>
        <form method="post" action="/logout"><button type="submit" class="button ghost">Logout</button></form>
      </div>
    </header>

    <section class="stats-grid">
      <article class="stat-card"><h3>Total permits</h3><p class="stat-value"><%= stats.total %></p></article>
      <% Object.entries(stats.statusCounts).forEach(([status, count]) => { %>
        <article class="stat-card"><h3><%= status.charAt(0).toUpperCase() + status.slice(1) %></h3><p class="stat-value"><%= count %></p></article>
      <% }) %>
    </section>

    <section class="card">
      <h2 class="section-title">Filters</h2>
      <form method="get" action="/permits" class="grid-form">
        <label>Status
          <select name="status">
            <option value="">All</option>
            <% statusOptions.forEach(s => { %>
              <option value="<%= s %>" <%= filters.status === s ? 'selected' : '' %>><%= s %></option>
            <% }) %>
          </select>
        </label>
        <label>Site<input name="site" value="<%= filters.site %>" /></label>
        <label>From<input type="date" name="startDate" value="<%= filters.startDate %>" /></label>
        <label>To<input type="date" name="endDate" value="<%= filters.endDate %>" /></label>
        <div class="row gap wrap"><button type="submit" class="button primary">Apply</button><a class="button ghost" href="/permits">Clear</a></div>
      </form>
    </section>

    <section class="card">
      <div class="row gap wrap">
        <% if (permissions.canCreate) { %><a class="button primary" href="/permits/new">New Permit</a><% } %>
        <a class="button" href="/permits/export.csv?status=<%= encodeURIComponent(filters.status) %>&site=<%= encodeURIComponent(filters.site) %>&startDate=<%= encodeURIComponent(filters.startDate) %>&endDate=<%= encodeURIComponent(filters.endDate) %>">Export CSV</a>
      </div>
    </section>

    <section class="table-card card">
      <div class="table-wrap">
        <table>
          <thead><tr><th>ID</th><th>Title</th><th>Type</th><th>Site</th><th>Status</th><th>Revision</th><th>Permit Date</th><th>Updated</th><th>By</th><th>Actions</th></tr></thead>
          <tbody>
            <% permits.forEach(p => { %>
              <tr>
                <td>#<%= p.id %></td>
                <td><strong><%= p.title %></strong></td>
                <td><%= p.permit_type || 'general_work_safe' %><% if (p.parent_permit_id) { %> (Parent #<%= p.parent_permit_id %>)<% } %></td>
                <td><%= p.site %></td>
                <td><span class="status-pill status-<%= p.status %>"><%= p.status %></span></td>
                <td>r<%= p.revision %></td>
                <td><%= p.permit_date %></td>
                <td><%= p.updated_at %></td>
                <td><%= p.updated_by_name %></td>
                <td>
                  <div class="row gap wrap">
                    <a href="/permits/<%= p.id %>">View</a>
                    <% if (p.actions.canEdit) { %><a href="/permits/<%= p.id %>/edit">Edit</a><% } %>
                    <a href="/permits/<%= p.id %>/audit">Audit</a>
                    <% if (p.actions.canDelete) { %>
                      <form method="post" action="/permits/<%= p.id %>/delete" onsubmit="return confirm('Delete permit #<%= p.id %>?');"><button type="submit" class="danger-link">Delete</button></form>
                    <% } %>
                  </div>
                </td>
              </tr>
            <% }) %>
            <% if (!permits.length) { %><tr><td colspan="10" class="muted">No permits found.</td></tr><% } %>
          </tbody>
        </table>
      </div>
    </section>
  </main>
</body>
</html>
