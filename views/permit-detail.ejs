<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Permit #<%= permit.id %> - <%= permit.title %></title>
  <link rel="stylesheet" href="/css/style.css" />
</head>
<body>
  <main class="container">
    <header class="page-header row wrap space-between gap">
      <div>
        <h1>Permit <%= permit.id %> <span class="status-pill status-<%= permit.status %>"><%= permit.status %></span></h1>
        <p class="muted"><%= permitTypeLabels[permit.permit_type || 'general_work_safe'] %> · revision <%= permit.revision %> · Start: <%= permitFieldValues.start_date || '—' %> <%= permitFieldValues.start_time || '' %> · <%= permit.is_locked ? 'Locked' : 'Editable' %></p>
      </div>
      <div class="row gap wrap">
        <a class="button ghost" href="/permits">Back</a>
        <% if (Number(permit.revision || 0) > 1) { %><a class="button" href="/permits/<%= permit.id %>/audit">Audit Trail</a><% } %>
        <a class="button" href="/permits/<%= permit.id %>/export.pdf">Export PDF</a>
        <% if (permissions.canEdit) { %>
          <a class="button primary" href="/permits/<%= permit.id %>/edit">Edit Permit</a>
        <% } %>
      </div>
    </header>

    <section class="detail-grid">
      <article class="card">
        <h2 class="section-title">Permit Details</h2>
        <dl class="detail-list">
          <div><dt>Site</dt><dd><%= permit.site %></dd></div>
          <div><dt>Permit Date</dt><dd><%= permit.permit_date %></dd></div>
          <div><dt>Type</dt><dd><%= permitTypeLabels[permit.permit_type || 'general_work_safe'] %></dd></div>
          <div><dt>Parent Permit</dt><dd><%= permit.parent_permit_id ? ('#' + permit.parent_permit_id) : '—' %></dd></div>
          <div><dt>Created By</dt><dd><%= permit.created_by_full_name || permit.created_by_name %></dd></div>
          <div><dt>Updated By</dt><dd><%= permit.updated_by_full_name ? (permit.updated_by_full_name + (permit.updated_by_position ? ' (' + permit.updated_by_position + ')' : '')) : permit.updated_by_name %></dd></div>
          <div><dt>Approved By</dt><dd><%= permit.approver_name || '—' %></dd></div>
          <div><dt>Approved At</dt><dd><%= permit.approved_at || '—' %></dd></div>
        </dl>
      </article>

      <article class="card">
        <h2 class="section-title">Workflow Actions</h2>
        <% if (workflowError) { %><p class="error"><%= workflowError %></p><% } %>
        <% if (!permissions.transitions.length) { %>
          <p class="muted">No transitions available for your role.</p>
        <% } else { %>
          <div class="row gap wrap">
            <% if (permissions.transitions.includes('submit')) { %>
              <form method="post" action="/permits/<%= permit.id %>/transition"><input type="hidden" name="action" value="submit" /><button class="button primary" type="submit">Submit</button></form>
            <% } %>
            <% if (permissions.transitions.includes('approve')) { %>
              <form method="post" action="/permits/<%= permit.id %>/transition" class="row gap wrap" id="approve-form">
                <input type="hidden" name="action" value="approve" />
                <div class="signature-block">
                  <label><span>Draw your signature (mouse or touch)</span></label>
                  <div class="signature-drawer">
                    <canvas id="signature-pad"></canvas>
                    <div class="row gap wrap" style="margin-top:6px;">
                      <button type="button" id="clear-signature" class="button ghost">Clear</button>
                      <small class="muted">Data is captured when you approve.</small>
                    </div>
                  </div>
                  <input type="hidden" name="signature_image" id="signature-image-input" />
                </div>
                <div class="row">
                  <button class="button primary" type="submit">Approve + Sign</button>
                </div>
              </form>
            <% } %>
            <% if (permissions.transitions.includes('close')) { %>
              <form method="post" action="/permits/<%= permit.id %>/transition"><input type="hidden" name="action" value="close" /><button class="button" type="submit">Close</button></form>
            <% } %>
            <% if (permissions.transitions.includes('reopen')) { %>
              <form method="post" action="/permits/<%= permit.id %>/transition" onsubmit="return confirm('Reopen this permit and increment revision?');"><input type="hidden" name="action" value="reopen" /><button class="button ghost" type="submit">Reopen</button></form>
            <% } %>
          </div>
        <% } %>
      </article>

      <article class="card">
        <h2 class="section-title">Required Permits</h2>
        <% if ((permit.permit_type || 'general_work_safe') !== 'general_work_safe') { %>
          <p class="muted">This is a supplemental permit linked to General Work Safe permit #<%= permit.parent_permit_id %>.</p>
        <% } else if (!requiredPermitTypes.length) { %>
          <p class="muted">No supplemental permits required.</p>
        <% } else { %>
          <ul class="activity-list">
            <% requiredPermitTypes.forEach(type => {
              const child = childPermits.find(p => p.permit_type === type);
            %>
              <li>
                <strong><%= permitTypeLabels[type] %></strong>
                <% if (!child) { %>
                  <span class="muted"> — missing</span>
                <% } else { %>
                  <span class="muted"> — status: <%= child.status %> · <a href="/permits/<%= child.id %>">Permit #<%= child.id %></a></span>
                <% } %>
              </li>
            <% }) %>
          </ul>
        <% } %>
      </article>

      <article class="card">
        <h2 class="section-title">Permit Form Details</h2>
        <% if (!permitFieldSchema?.length) { %>
          <p class="muted">No structured fields for this permit type.</p>
        <% } else { %>
          <%
            const grouped = permitFieldSchema.reduce((acc, f) => {
              const section = f.section || 'Form';
              if (!acc[section]) acc[section] = [];
              acc[section].push(f);
              return acc;
            }, {});
          %>
          <% Object.entries(grouped).forEach(([sectionName, fields]) => { %>
            <fieldset style="margin-bottom:12px;">
              <legend><%= sectionName %></legend>
              <dl class="detail-list">
                <% fields.forEach(f => { %>
                  <div>
                    <dt><%= f.label %></dt>
                    <dd>
                      <% if (f.type === 'checkbox') { %>
                        <%= Number(permitFieldValues[f.key]) ? 'Yes' : 'No' %>
                      <% } else { %>
                        <%= permitFieldValues[f.key] || '—' %>
                      <% } %>
                    </dd>
                  </div>
                <% }) %>
                <% if (sectionName === 'Section 1 – Additional Work Permits' && requiredPermitTypes?.length) { %>
                  <div>
                    <dt>Selected additional permits</dt>
                    <dd><%= requiredPermitTypes.map(t => permitTypeLabels[t]).join(', ') %></dd>
                  </div>
                <% } %>
              </dl>
            </fieldset>
          <% }) %>
        <% } %>
      </article>

      <article class="card">
        <h2 class="section-title">Description</h2>
        <p class="description"><%= permit.description || 'No description provided.' %></p>
      </article>

      <article class="card">
        <h2 class="section-title">Approval Signature</h2>
        <% if (permit.signature_text && permit.signature_text.startsWith('data:image')) { %>
          <img src="<%= permit.signature_text %>" alt="Signature" class="signature-graphic" />
        <% } else { %>
          <p><%= permit.signature_text || '—' %></p>
        <% } %>
      </article>

      <article class="card">
        <h2 class="section-title">Recent Activity</h2>
        <% if (!recentAudit.length) { %>
          <p class="muted">No audit events yet.</p>
        <% } else { %>
          <ul class="activity-list">
            <% recentAudit.forEach(row => { %>
              <li><strong><%= row.action %></strong> by <%= row.username %> <span class="muted">on <%= row.changed_at %></span></li>
            <% }) %>
          </ul>
        <% } %>
      </article>
    </section>
  </main>
  <script>
    (function () {
      const canvas = document.getElementById('signature-pad');
      const signatureImageInput = document.getElementById('signature-image-input');
      const approveForm = document.getElementById('approve-form');
      if (!canvas || !signatureImageInput) return;
      const ctx = canvas.getContext('2d');
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      ctx.lineWidth = 2.5;
      ctx.strokeStyle = '#111';
      canvas.style.touchAction = 'none';
      let drawing = false;
      let hasStroke = false;
      let lastPoint = null;

      function resizeCanvas() {
        const ratio = window.devicePixelRatio || 1;
        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width * ratio;
        canvas.height = rect.height * ratio;
        ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
        clearCanvas();
      }

      function toCanvasPoint(event) {
        const rect = canvas.getBoundingClientRect();
        const clientX = event.clientX ?? (event.touches && event.touches[0] && event.touches[0].clientX) ?? 0;
        const clientY = event.clientY ?? (event.touches && event.touches[0] && event.touches[0].clientY) ?? 0;
        return {
          x: clientX - rect.left,
          y: clientY - rect.top,
        };
      }

      function startDrawing(event) {
        event.preventDefault();
        drawing = true;
        hasStroke = true;
        lastPoint = toCanvasPoint(event);
      }

      function draw(event) {
        if (!drawing) return;
        event.preventDefault();
        const point = toCanvasPoint(event);
        ctx.beginPath();
        ctx.moveTo(lastPoint.x, lastPoint.y);
        ctx.lineTo(point.x, point.y);
        ctx.stroke();
        lastPoint = point;
      }

      function stopDrawing() {
        if (!drawing) return;
        drawing = false;
        updateSignatureImage();
      }

      function updateSignatureImage() {
        signatureImageInput.value = hasStroke ? canvas.toDataURL('image/png') : '';
      }

      function clearCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        hasStroke = false;
        updateSignatureImage();
      }

      canvas.addEventListener('pointerdown', (event) => {
        startDrawing(event);
        if (canvas.setPointerCapture) canvas.setPointerCapture(event.pointerId);
      });
      canvas.addEventListener('pointermove', draw);
      canvas.addEventListener('pointerup', stopDrawing);
      canvas.addEventListener('pointerleave', stopDrawing);
      canvas.addEventListener('pointercancel', stopDrawing);

      const clearButton = document.getElementById('clear-signature');
      if (clearButton) {
        clearButton.addEventListener('click', () => {
          clearCanvas();
        });
      }

      window.addEventListener('resize', resizeCanvas);
      resizeCanvas();

      if (approveForm) {
        approveForm.addEventListener('submit', (event) => {
          updateSignatureImage();
          const imageValue = (signatureImageInput.value || '').trim();
          if (!imageValue) {
            event.preventDefault();
            alert('Please draw your signature before approving.');
            return;
          }
        });
      }
    }());
  </script>
</body>
</html>
