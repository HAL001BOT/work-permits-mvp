<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title><%= permit ? 'Edit' : 'New' %> Permit</title>
  <link rel="stylesheet" href="/css/style.css" />
</head>
<body>
  <main class="container narrow">
    <header class="page-header">
      <h1><%= permit ? 'Edit' : 'Create New' %> Permit</h1>
      <p class="muted">Status transitions are controlled from the permit detail page.</p>
      <% if (permit?.parent_permit_id) { %>
        <p class="muted">Linked to General Work Safe Permit #<%= permit.parent_permit_id %>.</p>
      <% } %>
    </header>

    <% if (error) { %><p class="error"><%= error %></p><% } %>

    <%
      const currentType = permit?.permit_type || 'general_work_safe';
      const selectedRequired = (() => {
        if (!permit) return [];
        if (Array.isArray(permit.required_permits)) return permit.required_permits;
        try { return JSON.parse(permit.required_permits_json || '[]'); } catch { return []; }
      })();
      const fieldValues = permitFieldValues || {};
      const fieldErrs = fieldErrors || {};
      const supervisorOptionsList = supervisorOptions || [];
      const operatorOptionsList = operatorOptions || [];
      const defaultSignoffNameValue = defaultSignoffName || (user?.full_name || user?.username || 'Team Member');
      const today = new Date().toISOString().split('T')[0];
      const initialSignoffsData = (teamMemberSignoffs && teamMemberSignoffs.length) ? teamMemberSignoffs : [{ name: defaultSignoffNameValue, date: today }];
    %>

    <form method="post" action="<%= action %>" class="card form-stack">
      <input name="title" value="<%= currentType === 'general_work_safe' ? 'General safe work permit' : (permit?.title || '') %>" readonly />

      <% if (permitFieldSchema?.length) {
           const grouped = permitFieldSchema.reduce((acc, f) => {
             const section = f.section || 'Form';
             if (!acc[section]) acc[section] = [];
             acc[section].push(f);
             return acc;
           }, {});
        %>
        <% Object.entries(grouped).forEach(([sectionName, fields]) => {
             const sectionLocked = (sectionName === 'Section 5 – Approval & Closeout' && user?.role === 'requester');
          %>
          <fieldset class="collapsible-section" data-section-name="<%= sectionName %>">
            <legend>
              <button type="button" class="toggle-section" aria-expanded="true">
                <span><%= sectionName %></span>
                <span class="toggle-icon" aria-hidden="true">▾</span>
              </button>
            </legend>
            <div class="section-body">
              <% if (sectionLocked) { %><p class="muted">Only supervisor/admin can edit this section.</p><% } %>
              <div class="form-stack">
                <% fields.forEach(f => {
                     const rawValue = fieldValues[f.key];
                     const value = rawValue !== undefined && rawValue !== null ? rawValue : '';
                     const inputId = `pf__${f.key}`;
                     const inputName = f.persist === 'column' ? f.key : `pf__${f.key}`;
                     const baseRequired = f.required ? '1' : '0';
                     const labelAttrs = f.dependsOn ? ` class="dependent-field" data-dependent-target="${inputId}"` : '';
                     const controlTargets = f.key === 'contractor_company_enabled' ? 'pf__contractor_company pf__contractor_lead' : (f.key === 'project_number_needed' ? 'pf__project_number' : '');
                     const controlAttr = controlTargets ? ` data-controls="${controlTargets}"` : '';
                     const availableOptions = f.optionsSource === 'supervisors'
                       ? supervisorOptionsList
                       : (f.optionsSource === 'operators' ? operatorOptionsList : (f.options || []));
                 %>
                  <% if (!(sectionName === 'Section 1 – Additional Work Permits' && f.key === 'confirm_no_other_permits') && !(sectionName === 'Section 3 – Hazard Evaluation' && f.key === 'mobile_equipment_cert_initials')) { %>
                    <% if (f.component === 'signoffs') { %>
                      <div class="signoff-block">
                        <label><%= f.label %></label>
                        <div id="signoff-rows" class="signoff-rows"></div>
                        <button type="button" id="add-signoff-row" class="button ghost" style="width:auto;">Add personnel</button>
                        <input type="hidden" name="pf__team_member_signoffs" id="pf__team_member_signoffs" data-required="1" data-section="<%= sectionName %>" />
                        <% if (fieldErrs[f.key]) { %><small class="error"><%= fieldErrs[f.key] %></small><% } %>
                        <small class="muted">Use an operator name or type freely, then capture the date for each entry.</small>
                        <datalist id="operator-names">
                          <% operatorOptionsList.forEach(opt => { %><option value="<%= opt.label %>"></option><% }) %>
                        </datalist>
                      </div>
                    <% } else { %>
                      <label<%= labelAttrs %>>
                        <% const dataBaseRequiredAttr = `data-base-required="${baseRequired}"`; %>
                        <% if (f.type !== 'checkbox') { %><%= f.label %><% } %>
                        <% if (f.type === 'textarea') { %>
                          <textarea name="<%= inputName %>" rows="4" data-section="<%= sectionName %>" data-required="<%= baseRequired %>" <%= dataBaseRequiredAttr %><%= controlAttr %> <%= sectionLocked ? 'disabled' : '' %>><%= value %></textarea>
                        <% } else if (f.type === 'checkbox') { %>
                          <span class="check-option" style="margin-top:6px;">
                            <input id="<%= inputId %>" type="checkbox" name="<%= inputName %>" value="1" data-section="<%= sectionName %>" data-required="<%= baseRequired %>" <%= dataBaseRequiredAttr %><%= controlAttr %> <%= (Number(value) || f.forcedTrue) ? 'checked' : '' %> <%= (sectionLocked || f.forcedTrue) ? 'disabled' : '' %> />
                            <% if (f.forcedTrue) { %><input type="hidden" name="<%= inputName %>" value="1" /><% } %>
                            <span><%= f.label %></span>
                            <% if (f.key === 'haz_mobile_equipment') { %>
                              <input id="pf__mobile_equipment_cert_initials" name="pf__mobile_equipment_cert_initials" placeholder="Certification Initials" value="<%= fieldValues.mobile_equipment_cert_initials || '' %>" style="max-width:220px;" <%= sectionLocked ? 'disabled' : '' %> />
                            <% } %>
                            <% if (f.forcedTrue) { %><span class="muted">(Required)</span><% } %>
                          </span>
                        <% } else if (f.type === 'select') { %>
                          <select name="<%= inputName %>" id="<%= inputId %>" data-section="<%= sectionName %>" data-required="<%= baseRequired %>" <%= dataBaseRequiredAttr %><%= controlAttr %> <%= sectionLocked ? 'disabled' : '' %> >
                            <option value="">Select...</option>
                            <% availableOptions.forEach(opt => { %>
                              <% const optValue = typeof opt === 'string' ? opt : opt.value; %>
                              <% const optLabel = typeof opt === 'string' ? opt : opt.label; %>
                              <option value="<%= optValue %>" <%= String(value) === String(optValue) ? 'selected' : '' %>><%= optLabel %></option>
                            <% }) %>
                          </select>
                        <% } else { %>
                          <input type="<%= f.type === 'date' ? 'date' : (f.type === 'time' ? 'time' : 'text') %>" id="<%= inputId %>" name="<%= inputName %>" value="<%= value %>" <%= f.readOnly ? 'readonly' : '' %> data-section="<%= sectionName %>" data-required="<%= baseRequired %>" <%= dataBaseRequiredAttr %><%= controlAttr %> <%= sectionLocked ? 'disabled' : '' %> />
                        <% } %>
                        <% if (fieldErrs[f.key]) { %><small class="error"><%= fieldErrs[f.key] %></small><% } %>
                      </label>
                    <% } %>
                  <% } %>
                <% }) %>

                <% if (sectionName === 'Section 3 – Hazard Evaluation' && fieldErrs.hazards_group) { %><small class="error"><%= fieldErrs.hazards_group %></small><% } %>

                <% if (sectionName === 'Section 1 – Additional Work Permits' && currentType === 'general_work_safe') { %>
                  <label class="muted">Check all additional permits required for this job.</label>
                  <% supplementalPermitTypes.forEach(type => { %>
                    <label class="check-option">
                      <input type="checkbox" name="required_permits" value="<%= type %>" <%= selectedRequired.includes(type) ? 'checked' : '' %> />
                      <span><%= permitTypeLabels[type] %></span>
                    </label>
                  <% }) %>
                  <label class="check-option">
                    <input type="checkbox" name="pf__confirm_no_other_permits" value="1" <%= Number(fieldValues.confirm_no_other_permits) ? 'checked' : '' %> required />
                    <span>I confirm no other permits are needed</span>
                  </label>
                  <% if (fieldErrs.confirm_no_other_permits) { %><small class="error"><%= fieldErrs.confirm_no_other_permits %></small><% } %>
                <% } %>
              </div>
          </fieldset>
        <% }) %>
      <% } %>

      <div id="required-summary" class="card" style="margin:0;padding:10px 12px;background:#f8fafc;">
        <strong>Required sections summary:</strong>
        <small class="muted" id="required-summary-text">Checking required fields...</small>
      </div>

      <div class="row gap wrap">
        <button type="submit" class="button primary">Save Permit</button>
        <a class="button ghost" href="<%= permit ? '/permits/' + permit.id : '/permits' %>">Cancel</a>
      </div>
    </form>
  </main>
  <script>
    (function () {
      const mobileHazard = document.getElementById('pf__haz_mobile_equipment');
      const initials = document.getElementById('pf__mobile_equipment_cert_initials');
      if (mobileHazard && initials) {
        function syncInitialsVisibility() {
          const show = mobileHazard.checked;
          initials.style.display = show ? 'inline-block' : 'none';
          if (!show) initials.value = '';
        }
        mobileHazard.addEventListener('change', syncInitialsVisibility);
        syncInitialsVisibility();
      }

      const form = document.querySelector('form.form-stack');
      const permitId = '<%= permit?.id || '' %>';
      if (!form) return;

      let dirty = false;
      let autosaveTimer = null;
      const status = document.createElement('small');
      status.className = 'muted';
      status.style.marginTop = '6px';
      form.appendChild(status);

      const summaryText = document.getElementById('required-summary-text');
      function computeRequiredSummary() {
        const requiredNodes = Array.from(form.querySelectorAll('[data-required="1"]')).filter((el) => !el.disabled);
        const missingBySection = new Map();
        requiredNodes.forEach((el) => {
          const section = el.getAttribute('data-section') || 'Form';
          const missing = el.type === 'checkbox' ? !el.checked : !String(el.value || '').trim();
          if (!missing) return;
          missingBySection.set(section, (missingBySection.get(section) || 0) + 1);
        });

        if (!summaryText) return;
        if (!missingBySection.size) {
          summaryText.textContent = 'All required sections complete.';
          return;
        }
        const parts = Array.from(missingBySection.entries()).map(([section, count]) => `${section} (${count})`);
        summaryText.textContent = `Missing required fields in: ${parts.join(', ')}`;
      }

      form.addEventListener('input', () => { dirty = true; computeRequiredSummary(); });
      form.addEventListener('change', () => { dirty = true; computeRequiredSummary(); });

      async function autosave() {
        if (!dirty || !permitId) return;
        dirty = false;
        const data = new URLSearchParams(new FormData(form));
        try {
          const res = await fetch(`/permits/${permitId}/autosave`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: data.toString(),
          });
          if (res.ok) {
            const payload = await res.json();
            const at = new Date(payload.savedAt).toLocaleTimeString();
            status.textContent = payload.changed ? `Draft autosaved at ${at}` : `No changes to save (${at})`;
          }
        } catch (_e) {
          status.textContent = 'Autosave failed';
        }
      }

      const dependencyControllers = Array.from(document.querySelectorAll('[data-controls]'));
      function setDependentFieldState(input, enabled) {
        const label = document.querySelector(`[data-dependent-target="${input.id}"]`);
        if (label) label.classList.toggle('dependent-field-hidden', !enabled);
        input.disabled = !enabled;
        if (!enabled) {
          if (input.type === 'checkbox') input.checked = false;
          else input.value = '';
        }
        const baseRequired = input.dataset.baseRequired === '1';
        input.setAttribute('data-required', enabled && baseRequired ? '1' : '0');
      }
      dependencyControllers.forEach((ctrl) => {
        const targetIds = (ctrl.dataset.controls || '').split(/\s+/).filter(Boolean);
        const targets = targetIds.map((id) => document.getElementById(id)).filter(Boolean);
        const sync = () => {
          const enabled = Boolean(ctrl.checked);
          targets.forEach((input) => setDependentFieldState(input, enabled));
        };
        ctrl.addEventListener('change', sync);
        sync();
      });

      const signoffRows = document.getElementById('signoff-rows');
      const signoffHidden = document.getElementById('pf__team_member_signoffs');
      const addSignoffBtn = document.getElementById('add-signoff-row');
      const signoffDefaultName = <%- JSON.stringify(defaultSignoffNameValue) %>;
      const signoffDefaultDate = '<%= today %>';
      const initialSignoffs = <%- JSON.stringify(initialSignoffsData) %>;
      let signoffEntries = Array.isArray(initialSignoffs) ? initialSignoffs.slice() : [];
      function updateSignoffHidden() {
        if (signoffHidden) signoffHidden.value = JSON.stringify(signoffEntries);
      }
      function renderSignoffRows() {
        if (!signoffRows) return;
        signoffRows.innerHTML = '';
        if (!signoffEntries.length) signoffEntries.push({ name: signoffDefaultName, date: signoffDefaultDate });
        signoffEntries.forEach((entry, index) => {
          const row = document.createElement('div');
          row.className = 'signoff-row';
          const nameInput = document.createElement('input');
          nameInput.type = 'text';
          nameInput.placeholder = 'Name';
          nameInput.value = entry.name || '';
          nameInput.setAttribute('list', 'operator-names');
          nameInput.addEventListener('input', () => {
            signoffEntries[index].name = nameInput.value;
            updateSignoffHidden();
          });
          const dateInput = document.createElement('input');
          dateInput.type = 'date';
          dateInput.value = entry.date || signoffDefaultDate;
          dateInput.addEventListener('input', () => {
            signoffEntries[index].date = dateInput.value;
            updateSignoffHidden();
          });
          const removeBtn = document.createElement('button');
          removeBtn.type = 'button';
          removeBtn.className = 'button ghost';
          removeBtn.textContent = 'Remove';
          removeBtn.addEventListener('click', () => {
            signoffEntries.splice(index, 1);
            if (!signoffEntries.length) signoffEntries.push({ name: signoffDefaultName, date: signoffDefaultDate });
            renderSignoffRows();
          });
          row.append(nameInput, dateInput, removeBtn);
          signoffRows.appendChild(row);
        });
        updateSignoffHidden();
      }
      if (signoffRows) renderSignoffRows();
      if (addSignoffBtn) {
        addSignoffBtn.addEventListener('click', () => {
          signoffEntries.push({ name: '', date: signoffDefaultDate });
          renderSignoffRows();
        });
      }

      const toggles = Array.from(document.querySelectorAll('.toggle-section'));
      toggles.forEach((btn) => {
        const section = btn.closest('.collapsible-section');
        if (!section) return;
        const body = section.querySelector('.section-body');
        const icon = btn.querySelector('.toggle-icon');
        const setState = (expanded) => {
          btn.setAttribute('aria-expanded', expanded ? 'true' : 'false');
          if (icon) icon.textContent = expanded ? '▾' : '▸';
          if (body) body.hidden = !expanded;
        };
        const defaultExpanded = Boolean(permitId);
        setState(defaultExpanded);
        btn.addEventListener('click', () => {
          const expanded = btn.getAttribute('aria-expanded') === 'true';
          setState(!expanded);
        });
      });

      computeRequiredSummary();
      if (permitId) {
        autosaveTimer = setInterval(autosave, 20000);
      }
      window.addEventListener('beforeunload', () => { if (autosaveTimer) clearInterval(autosaveTimer); });
    })();
  </script>
</body>
</html>
