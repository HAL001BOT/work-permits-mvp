<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title><%= permit ? 'Edit' : 'New' %> Permit</title>
  <link rel="stylesheet" href="/css/style.css" />
</head>
<body>
  <main class="container narrow">
    <header class="page-header">
      <h1><%= permit ? 'Edit' : 'Create New' %> Permit</h1>
      <p class="muted">Status transitions are controlled from the permit detail page.</p>
      <% if (permit?.parent_permit_id) { %>
        <p class="muted">Linked to General Work Safe Permit #<%= permit.parent_permit_id %>.</p>
      <% } %>
    </header>

    <% if (error) { %><p class="error"><%= error %></p><% } %>

    <%
      const currentType = permit?.permit_type || 'general_work_safe';
      const selectedRequired = (() => {
        if (!permit) return [];
        if (Array.isArray(permit.required_permits)) return permit.required_permits;
        try { return JSON.parse(permit.required_permits_json || '[]'); } catch { return []; }
      })();
      const fieldValues = permitFieldValues || {};
      const fieldErrs = fieldErrors || {};
    %>

    <form method="post" action="<%= action %>" class="card form-stack">
      <input name="title" value="<%= currentType === 'general_work_safe' ? 'General safe work permit' : (permit?.title || '') %>" readonly />

      <% if (permitFieldSchema?.length) {
           const grouped = permitFieldSchema.reduce((acc, f) => {
             const section = f.section || 'Form';
             if (!acc[section]) acc[section] = [];
             acc[section].push(f);
             return acc;
           }, {});
        %>
        <% Object.entries(grouped).forEach(([sectionName, fields]) => {
             const sectionLocked = (sectionName === 'Section 5 – Approval & Closeout' && user?.role === 'requester');
          %>
          <fieldset>
            <legend><%= sectionName %></legend>
            <% if (sectionLocked) { %><p class="muted">Only supervisor/admin can edit this section.</p><% } %>
            <div class="form-stack">
              <% fields.forEach(f => { %>
                <% if (!(sectionName === 'Section 1 – Additional Work Permits' && f.key === 'confirm_no_other_permits') && !(sectionName === 'Section 3 – Hazard Evaluation' && f.key === 'mobile_equipment_cert_initials')) { %>
                  <label>
                    <% if (f.type !== 'checkbox') { %><%= f.label %><% } %>
                    <% if (f.type === 'textarea') { %>
                      <textarea name="pf__<%= f.key %>" rows="4" <%= f.required ? 'required' : '' %> <%= sectionLocked ? 'disabled' : '' %>><%= fieldValues[f.key] || '' %></textarea>
                    <% } else if (f.type === 'checkbox') { %>
                      <span class="check-option" style="margin-top:6px;">
                        <input id="pf__<%= f.key %>" type="checkbox" name="pf__<%= f.key %>" value="1" <%= (f.forcedTrue || Number(fieldValues[f.key])) ? 'checked' : '' %> <%= (f.forcedTrue || sectionLocked) ? 'disabled' : '' %> />
                        <% if (f.forcedTrue) { %><input type="hidden" name="pf__<%= f.key %>" value="1" /><% } %>
                        <span><%= f.label %></span>
                        <% if (f.key === 'haz_mobile_equipment') { %>
                          <input id="pf__mobile_equipment_cert_initials" name="pf__mobile_equipment_cert_initials" placeholder="Certification Initials" value="<%= fieldValues.mobile_equipment_cert_initials || '' %>" style="max-width:220px;" <%= sectionLocked ? 'disabled' : '' %> />
                        <% } %>
                        <% if (f.forcedTrue) { %><span class="muted">(Required)</span><% } %>
                      </span>
                    <% } else if (f.type === 'select') { %>
                      <select name="pf__<%= f.key %>" <%= f.required ? 'required' : '' %> <%= sectionLocked ? 'disabled' : '' %> >
                        <option value="">Select...</option>
                        <% (f.options || []).forEach(opt => { %>
                          <option value="<%= opt %>" <%= String(fieldValues[f.key] || '') === String(opt) ? 'selected' : '' %>><%= opt %></option>
                        <% }) %>
                      </select>
                    <% } else { %>
                      <input type="<%= f.type === 'date' ? 'date' : (f.type === 'time' ? 'time' : 'text') %>" name="pf__<%= f.key %>" value="<%= fieldValues[f.key] || '' %>" <%= f.readOnly ? 'readonly' : '' %> <%= f.required ? 'required' : '' %> <%= sectionLocked ? 'disabled' : '' %> />
                    <% } %>
                    <% if (fieldErrs[f.key]) { %><small class="error"><%= fieldErrs[f.key] %></small><% } %>
                  </label>
                <% } %>

                <% if (sectionName === 'General Information' && f.key === 'start_date') { %>
                  <label>Permit End Date
                    <input type="date" name="permit_date" required value="<%= permit?.permit_date || '' %>" />
                  </label>
                  <label>Site
                    <% if (currentType === 'general_work_safe') { %>
                      <input name="site" value="Cleburne" readonly />
                    <% } else { %>
                      <input name="site" value="<%= permit?.site || '' %>" />
                    <% } %>
                  </label>
                <% } %>
              <% }) %>

              <% if (sectionName === 'Section 3 – Hazard Evaluation' && fieldErrs.hazards_group) { %><small class="error"><%= fieldErrs.hazards_group %></small><% } %>

              <% if (sectionName === 'Section 1 – Additional Work Permits' && currentType === 'general_work_safe') { %>
                <label class="muted">Check all additional permits required for this job.</label>
                <% supplementalPermitTypes.forEach(type => { %>
                  <label class="check-option">
                    <input type="checkbox" name="required_permits" value="<%= type %>" <%= selectedRequired.includes(type) ? 'checked' : '' %> />
                    <span><%= permitTypeLabels[type] %></span>
                  </label>
                <% }) %>
                <label class="check-option">
                  <input type="checkbox" name="pf__confirm_no_other_permits" value="1" <%= Number(fieldValues.confirm_no_other_permits) ? 'checked' : '' %> required />
                  <span>I confirm no other permits are needed</span>
                </label>
                <% if (fieldErrs.confirm_no_other_permits) { %><small class="error"><%= fieldErrs.confirm_no_other_permits %></small><% } %>
              <% } %>
            </div>
          </fieldset>
        <% }) %>
      <% } %>

      <div class="row gap wrap">
        <button type="submit" class="button primary">Save Permit</button>
        <a class="button ghost" href="<%= permit ? '/permits/' + permit.id : '/permits' %>">Cancel</a>
      </div>
    </form>
  </main>
  <script>
    (function () {
      const mobileHazard = document.getElementById('pf__haz_mobile_equipment');
      const initials = document.getElementById('pf__mobile_equipment_cert_initials');
      if (mobileHazard && initials) {
        function syncInitialsVisibility() {
          const show = mobileHazard.checked;
          initials.style.display = show ? 'inline-block' : 'none';
          if (!show) initials.value = '';
        }
        mobileHazard.addEventListener('change', syncInitialsVisibility);
        syncInitialsVisibility();
      }

      const form = document.querySelector('form.form-stack');
      const permitId = '<%= permit?.id || '' %>';
      if (!form || !permitId) return;

      let dirty = false;
      let autosaveTimer = null;
      const status = document.createElement('small');
      status.className = 'muted';
      status.style.marginTop = '6px';
      form.appendChild(status);

      form.addEventListener('input', () => { dirty = true; });
      form.addEventListener('change', () => { dirty = true; });

      async function autosave() {
        if (!dirty) return;
        dirty = false;
        const data = new URLSearchParams(new FormData(form));
        try {
          const res = await fetch(`/permits/${permitId}/autosave`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: data.toString(),
          });
          if (res.ok) status.textContent = 'Draft autosaved';
        } catch (_e) {
          status.textContent = 'Autosave failed';
        }
      }

      autosaveTimer = setInterval(autosave, 20000);
      window.addEventListener('beforeunload', () => { if (autosaveTimer) clearInterval(autosaveTimer); });
    })();
  </script>
</body>
</html>
