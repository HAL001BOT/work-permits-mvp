<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title><%= permit ? 'Edit' : 'New' %> Permit</title>
  <link rel="stylesheet" href="/css/style.css" />
</head>
<body>
  <main class="container narrow">
    <header class="page-header">
      <h1><%= permit ? 'Edit' : 'Create New' %> Permit</h1>
      <p class="muted">Status transitions are controlled from the permit detail page.</p>
      <% if (permit?.parent_permit_id) { %>
        <p class="muted">Linked to General Work Safe Permit #<%= permit.parent_permit_id %>.</p>
      <% } %>
    </header>

    <% if (error) { %><p class="error"><%= error %></p><% } %>

    <%
      const currentType = permit?.permit_type || 'general_work_safe';
      const selectedRequired = (() => {
        if (!permit) return [];
        if (Array.isArray(permit.required_permits)) return permit.required_permits;
        try { return JSON.parse(permit.required_permits_json || '[]'); } catch { return []; }
      })();
      const fieldValues = permitFieldValues || {};
    %>

    <form method="post" action="<%= action %>" class="card form-stack">
      <label>Title
        <input name="title" required value="<%= permit?.title || '' %>" />
      </label>
      <label>Description
        <textarea name="description" rows="6"><%= permit?.description || '' %></textarea>
      </label>
      <label>Site
        <input name="site" required value="<%= permit?.site || '' %>" />
      </label>
      <label>Permit Date
        <input type="date" name="permit_date" required value="<%= permit?.permit_date || '' %>" />
      </label>

      <label>Permit Type
        <input value="<%= permitTypeLabels[currentType] || currentType %>" disabled />
      </label>

      <% if (currentType === 'general_work_safe') { %>
        <fieldset>
          <legend>Required supplemental permits</legend>
          <p class="muted">Select all permits that must be completed before this General Work Safe permit can be approved.</p>
          <div class="form-stack">
            <% supplementalPermitTypes.forEach(type => { %>
              <label class="row gap" style="align-items:center;">
                <input type="checkbox" name="required_permits" value="<%= type %>" <%= selectedRequired.includes(type) ? 'checked' : '' %> />
                <span><%= permitTypeLabels[type] %></span>
              </label>
            <% }) %>
          </div>
        </fieldset>
      <% } %>

      <% if (permitFieldSchema?.length) { %>
        <fieldset>
          <legend><%= permitTypeLabels[currentType] || currentType %> Template Fields</legend>
          <div class="form-stack">
            <% permitFieldSchema.forEach(f => { %>
              <label>
                <%= f.label %>
                <% if (f.type === 'textarea') { %>
                  <textarea name="pf__<%= f.key %>" rows="4"><%= fieldValues[f.key] || '' %></textarea>
                <% } else if (f.type === 'checkbox') { %>
                  <span class="row gap" style="align-items:center; margin-top:6px;">
                    <input type="checkbox" name="pf__<%= f.key %>" value="1" <%= Number(fieldValues[f.key]) ? 'checked' : '' %> />
                    <span class="muted">Yes</span>
                  </span>
                <% } else { %>
                  <input type="<%= f.type === 'date' ? 'date' : 'text' %>" name="pf__<%= f.key %>" value="<%= fieldValues[f.key] || '' %>" />
                <% } %>
              </label>
            <% }) %>
          </div>
        </fieldset>
      <% } %>

      <div class="row gap wrap">
        <button type="submit" class="button primary">Save Permit</button>
        <a class="button ghost" href="<%= permit ? '/permits/' + permit.id : '/permits' %>">Cancel</a>
      </div>
    </form>
  </main>
</body>
</html>
